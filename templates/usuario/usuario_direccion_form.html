{% extends 'base/base.html' %}
{% block extrastatic %}
    {% load staticfiles %}
    <link rel="stylesheet" href="{% static 'assets/js/plugins/select2/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/js/plugins/select2/select2-bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'assets/js/plugins/jquery-ui/jquery-ui.min.css' %}">
{% endblock %}
{% block pageheader %}
Usuario
{% endblock %}
{% block subpageheader %}
   Dirección
{% endblock %}
{% block breadcrumbs %}
<div class="col-sm-5 text-right hidden-xs" xmlns="http://www.w3.org/1999/html">
    <ol class="breadcrumb push-10-t">
        <li><a class="link-effect" href="{% url 'home' %}">Inicio</a></li>
        <li><a class="link-effect" href="">Editar Dirección</a></li>
    </ol>
 </div>
{% endblock %}

{% block content %}

    <div class="content">
    <form id="form_direccion" class="js-validation-material form-horizontal push-10-t" method="POST">
    {% csrf_token %}
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <div class="block block-rounded">
                    <div class="block-header bg-primary">
                        <h3 class="block-title">Dirección</h3>
                    </div>
                    <div class="block-content">
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                               {{ form.pais }}
                                               <label for="{{ form.pais.name }}">{{ form.pais.label }}</label>
                                            </div>
                                         </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                                {{ form.estado }}
                                                <label for="{{ form.estado.name }}">{{ form.estado.label }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                                {{ form.municipio }}
                                                <label for="{{ form.municipio.name }}">{{ form.municipio.label }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                                {{ form.ciudad }}
                                                <label for="{{ form.ciudad.name }}">{{ form.ciudad.label }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                                {{ form.asentamiento }}
                                                <label for="{{ form.asentamiento.name }}">{{ form.asentamiento.label }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                                {{ form.calle }}
                                                <label for="{{ form.calle.name }}">{{ form.calle.label }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                 <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                                {{ form.numero_exterior }}
                                                <label for="{{ form.numero_exterior.name }}">{{ form.numero_exterior.label }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                 <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                                {{ form.numero_interior }}
                                                <label for="{{ form.numero_interior.name }}">{{ form.numero_interior.label }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                                {{ form.codigo_postal }}
                                                <label for="{{ form.codigo_postal.name }}">{{ form.codigo_postal.label }}
                                                <a id="btn_codigopostal" class="btn btn-info btn-xs" type="button" data-toggle='tooltip' title='Buscar Codigo Postal por Asentamiento'>
                                                    <i class="fa fa-search "></i>
                                                </a></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-10 col-md-offset-1">
                                    <div class="form-group">
                                        <div class="col-sm-12">
                                            <div class="form-material form-material-primary">
                                                {{ form.datos_adicionales }}
                                                <label for="{{ form.datos_adicionales.name }}">{{ form.datos_adicionales.label }}</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 col-md-offset-4">
                                <div class="form-group">
                                     <div class="col-sm-12">
                                         <input type="submit" value="Guardar" class="btn btn-primary guardar" disabled="true">
                                         <a href="{% url 'home' %}" class="btn btn-danger" >Cancelar</a>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% endblock %}
{% block extrajs %}
    {% load staticfiles %}
    <script src="{% static 'assets/js/plugins/select2/select2.full.min.js' %}"></script>
    <script src="{% static 'assets/js/plugins/select2/select2_locale_es.js' %}"></script>
    <script src="{% static 'assets/js/csfr.js' %}"></script>
    <script src="{% static 'assets/js/plugins/jquery-validation/jquery.validate.min.js' %}"></script>
    <script src="{% static 'assets/js/plugins/jquery-validation/messages_es.min.js' %}"></script>
    <script src="{% static 'usuario/js/direccion_form_validation.js' %}"></script>
    <script>
        $(document).ready(function() {
            "use strict";
            var flag = true;
            var cabeceras;
            $("input#id_pais").prop('readonly', true);
            function cargarEstados(estado,municipio)
            {   $("select#id_estado").empty().append($('<option>').text(''));
                $.ajax({url: "{% url 'comun:asentamientos_api' %}",
                        headers: { 'Authorization' : 'Token {{ request.session.token }}' },
                        data:{consulta:'estado'},
                        dataType:"json",
                        type:"GET"
                }).done(function(data){
                    $.each(data, function(index, item) {
                        $("select#id_estado").append($('<option>').attr('value',item.entidad).text(item.entidad));
                    });
                    if(estado) {
                        $("select#id_estado").val(estado).change();
                        cargarMunicipios(municipio);
                    }
                })
            }
            function cargarMunicipios(municipio)
            {   $("select#id_municipio").empty().append($('<option>').text(''));
                var estado = $('select#id_estado').val();
                var id = 0;
                cabeceras = [];
                $.ajax({url: "{% url 'comun:asentamientos_api' %}",
                        headers: { 'Authorization' : 'Token {{ request.session.token }}' },
                        data:{consulta:'municipio',estado:estado},
                        dataType:"json",
                        type:"GET"
                }).done(function(data){
                    $.each(data, function(index, item) {
                        $("select#id_municipio").append($('<option>').attr({'value':item.municipio,'id':id}).text(item.municipio));
                        cabeceras[id]=item.municipio;
                        id++;
                    });
                    if(municipio) {
                        $("select#id_municipio").val(municipio).change();
                        $("input.guardar").removeAttr("disabled");
                        flag = true;
                    }
                });
            }
            function cargarCodigoPostal()
            {   var estado = $('select#id_estado').val();
                var municipio = $('select#id_municipio').val();
                var asentamiento = $('input#id_asentamiento').val();
                $.ajax({url: "{% url 'comun:asentamientos_api' %}",
                        headers: { 'Authorization' : 'Token {{ request.session.token }}' },
                        data:{consulta:'codigopostal',estado:estado,municipio:municipio,asentamiento:asentamiento},
                        dataType:"json",
                        type:"GET"
                }).done(function(data){
                    $("input#id_codigo_postal").val(data.codigopostal);
                });
            }
            $("select#id_estado").select2({language: "es", allowClear: true, placeholder: "Estado"}).on('change',function(e) {
                if(flag)cargarMunicipios(null);
            });
            $( "input#id_asentamiento").autocomplete({
                source: function( request, response ) {
                    var estado = $('select#id_estado').val();
                    var municipio = $('select#id_municipio').val();
                    $.ajax({
                        url: "{% url 'comun:asentamientos_api' %}",
                        headers: { 'Authorization' : 'Token {{ request.session.token }}' },
                        dataType:"json",
                        type:"GET",
                        data: {
                            consulta:'asentamiento', asentamiento: request.term, estado:estado, municipio:municipio
                        },
                        success: function( data ) {
                            response( $.map( data, function(item) {
                                return{
                                    label: item.asentamiento
                                }
                            }));
                        }
                    });
                },
                minLength: 3,
                select: function( event, ui ) {
                    cargarCodigoPostal();
                },
                open: function() {
                    $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
                },
                close: function() {
                    $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
                }
            });
            $("input#id_ciudad").autocomplete({
                source: function( request, response ) {
                    var estado = $('select#id_estado').val();
                    var municipio = $('select#id_municipio').val();
                    $.ajax({
                        url: "{% url 'comun:asentamientos_api' %}",
                        headers: { 'Authorization' : 'Token {{ request.session.token }}' },
                        dataType:"json",
                        type:"GET",
                        data: {
                            consulta:'ciudad', ciudad: request.term, estado:estado, municipio:municipio
                        },
                        success: function( data ) {
                            response( $.map( data, function(item) {
                                return{
                                    label: item.cabecera
                                }
                            }));
                        }
                    });
                },
                minLength: 1,
                open: function() {
                    $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
                },
                close: function() {
                    $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
                }
            });
            $("select#id_municipio").select2({language: "es", allowClear: true, placeholder: "Municipio"});
            function cargar()
            {       $.ajax({url: "{% url 'empleado:datos_api' %}",
                        headers: { 'Authorization' : 'Token {{ request.session.token }}' },
                        data:{usuario:true},
                        dataType:"json",
                        type:"GET"
                    }).done(function(data) {
                        if(data.activo == 1){
                            $("input#id_pais").attr('value', '' + data.empleado.direccion.pais);
                            $("input#id_calle").attr('value', '' + data.empleado.direccion.calle);
                            $("input#id_numero_exterior").attr('value', '' + data.empleado.direccion.numero_exterior);
                            $("input#id_numero_interior").attr('value', '' + data.empleado.direccion.numero_interior);
                            $("textarea#id_datos_adicionales").val(data.empleado.direccion.datos_adicionales);
                            $("input#id_ciudad").val(data.empleado.direccion.ciudad);
                            $("input#id_asentamiento").val(data.empleado.direccion.asentamiento);
                            $("input#id_codigo_postal").val(data.empleado.direccion.codigo_postal);
                            var estado = data.empleado.direccion.estado;
                            var municipio = data.empleado.direccion.municipio;
                            if (estado == ""){
                                cargarEstados();
                                flag = true;
                                $("input.guardar").removeAttr("disabled");
                            }
                            else
                                cargarEstados(estado,municipio);
                        }
                        else
                        {   $('form#form_direccion').remove();
                            $('div#modal_error').modal('show');
                        }
                    }).fail(function(){
                        $('form#form_direccion').remove();
                        $('div#modal_error').modal('show');
                    })
            }
            cargar();
            $("form#form_direccion").submit(function(event){
                $("input.guardar").attr("disabled", true);
            });
            $("a#btn_codigopostal").click(function () {
                cargarCodigoPostal();
            }).tooltip({placement:'bottom'});
        });
    </script>
{% endblock %}